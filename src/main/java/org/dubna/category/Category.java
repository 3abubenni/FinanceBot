package org.dubna.category;

import io.quarkus.hibernate.orm.panache.PanacheEntityBase;
import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Getter;
import lombok.NoArgsConstructor;
import lombok.Setter;
import org.dubna.budget.OperationType;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.stream.Stream;

@Entity
@Table(name = "category")
@Getter
@Setter
@Builder
@AllArgsConstructor
@NoArgsConstructor
public class Category extends PanacheEntityBase {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "name", nullable = false)
    private String name;

    @Column(name = "user_id", nullable = false)
    private Long userId;

    @Enumerated(EnumType.STRING)
    @Column(name = "type", nullable = false)
    private OperationType type;

    @OneToMany(
            mappedBy = "category",
            fetch = FetchType.LAZY,
            orphanRemoval = true,
            cascade = CascadeType.ALL
    )
    private List<Keyword> keywords;

    private Category(String name, OperationType type, String... keywords) {
        this.name = name.toLowerCase();
        this.type = type;
        for (int i = 0; i < keywords.length; i++) {
            keywords[i] = keywords[i].toLowerCase();
        }

        this.keywords = Stream.of(keywords)
                .map(keyword -> new Keyword(keyword, this))
                .toList();
    }

    public void addKeyword(String word) {
        if (!hasKeyword(word)) {
            Keyword keyword = new Keyword(word, this);
            keywords.add(keyword);
            keyword.persist();
        }
    }

    public static List<Category> findByUserId(Long id) {
        return find("userId", id).list();
    }

    public boolean hasKeyword(String word) {
        return Keyword.existsByKeywordAndCategory(word, this);
    }

    public static Optional<Category> findByNameOrKeywordAndUserId(String keyword, Long userId) {
        String searchKeyword = keyword.toLowerCase();

        return find("""
                        SELECT DISTINCT c FROM Category c
                        LEFT JOIN FETCH c.keywords k
                        WHERE k.keyword = ?1 AND c.userId = ?2
                        """,
                searchKeyword, userId).firstResultOptional();
    }

    public static void initCategoriesForNewUser(Long userId) {
        List<Category> categories = createDefaultCategories();
        categories.forEach(category -> category.setUserId(userId));
        persist(categories);
    }

    private static List<Category> createDefaultCategories() {
        List<Category> categories = new ArrayList<>();

        categories.add(new Category("üõí –ü—Ä–æ–¥—É–∫—Ç—ã", OperationType.TOPUP,
                "–ø—Ä–æ–¥—É–∫—Ç—ã", "–µ–¥–∞", "–ø–∏—â–∞", "–ø–∏—Ç–∞–Ω–∏–µ", "–ø–æ–∫—É–ø–∫–∞",
                "—Å—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç", "–º–∞–≥–∞–∑–∏–Ω", "–º–∞—Ä–∫–µ—Ç", "–≥–∏–ø–µ—Ä–º–∞—Ä–∫–µ—Ç",
                "–æ–≤–æ—â–∏", "—Ñ—Ä—É–∫—Ç—ã", "–º–æ–ª–æ–∫–æ", "—Ö–ª–µ–±", "–º—è—Å–æ", "—Ä—ã–±–∞",
                "—Å–ª–∞–¥–æ—Å—Ç–∏", "–Ω–∞–ø–∏—Ç–∫–∏", "–≤–æ–¥–∞", "—Å–æ–∫", "—á–∞–π",
                "–∑–∞–∫–∞–∑", "–¥–æ—Å—Ç–∞–≤–∫–∞", "–µ–¥–∞—Å–∫–∏", "—è–º–∫—É—Ö–Ω—è", "—è–Ω–¥–µ–∫—Å.–µ–¥–∞",
                "—Å–∞–ª–∞—Ç", "—Å—É–ø", "–≥–∞—Ä–Ω–∏—Ä", "–¥–µ—Å–µ—Ä—Ç"));

        categories.add(new Category("üçΩÔ∏è –ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã", OperationType.TOPUP,
                "–∫–∞—Ñ–µ", "—Ä–µ—Å—Ç–æ—Ä–∞–Ω", "—Å—Ç–æ–ª–æ–≤–∞—è", "–±–∏—Å—Ç—Ä–æ", "–∫–æ—Ñ–µ–π–Ω—è",
                "—Ñ–∞—Å—Ç—Ñ—É–¥", "–±—É—Ä–≥–µ—Ä", "–ø–∏—Ü—Ü–∞", "—Å—É—à–∏", "—Ä–æ–ª–ª—ã", "–∫–æ—Ñ–µ",
                "—à–∞—É—Ä–º–∞", "—à–∞–≤–µ—Ä–º–∞", "–¥–æ–Ω–µ—Ä", "–±—É—Ä–≥–µ—Ä–Ω–∞—è", "–ø–∏—Ü—Ü–µ—Ä–∏—è",
                "–∑–∞–≤—Ç—Ä–∞–∫", "–æ–±–µ–¥", "—É–∂–∏–Ω", "–ª–∞–Ω—á", "–±–∏–∑–Ω–µ—Å-–ª–∞–Ω—á",
                "–ø–µ—Ä–µ–∫—É—Å", "–±—É—Ç–µ—Ä–±—Ä–æ–¥", "—Å—ç–Ω–¥–≤–∏—á", "–±—É–ª–æ—á–∫–∞", "–≤—ã–ø–µ—á–∫–∞",
                "–¥–æ—Å—Ç–∞–≤–∫–∞", "delivery", "–∑–∞–∫–∞–∑–∞–ª"));

        categories.add(new Category("üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç", OperationType.TOPUP,
                "—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç", "–ø–æ–µ–∑–¥–∫–∞", "–ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ",
                "—Ç–∞–∫—Å–∏", "—è–Ω–¥–µ–∫—Å.—Ç–∞–∫—Å–∏", "uber", "—Å–∏—Ç–∏–º–æ–±–∏–ª",
                "–º–µ—Ç—Ä–æ", "–∞–≤—Ç–æ–±—É—Å", "—Ç—Ä–æ–ª–ª–µ–π–±—É—Å", "—Ç—Ä–∞–º–≤–∞–π",
                "–∫–∞—Ä—à–µ—Ä–∏–Ω–≥", "–¥–µ–ª–∏–º–æ–±–∏–ª—å", "—è–Ω–¥–µ–∫—Å.–¥—Ä–∞–π–≤", "belkacar",
                "–±–µ–Ω–∑–∏–Ω", "—Ç–æ–ø–ª–∏–≤–æ", "–∑–∞–ø—Ä–∞–≤–∫–∞", "–∞–∑—Å", "–ª—É–∫–æ–π–ª", "–≥–∞–∑–ø—Ä–æ–º",
                "–ø–∞—Ä–∫–æ–≤–∫–∞", "—à—Ç—Ä–∞—Ñ", "–≥–æ—Å—É—Å–ª—É–≥–∏", "–≥–∏–±–¥–¥",
                "—Ä–µ–º–æ–Ω—Ç", "—à–∏–Ω–æ–º–æ–Ω—Ç–∞–∂", "–º–æ–π–∫–∞", "–∞–≤—Ç–æ—Å–µ—Ä–≤–∏—Å",
                "—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞", "–æ—Å–∞–≥–æ", "–∫–∞—Å–∫–æ"));

        categories.add(new Category("üè† –ñ–∏–ª—å–µ –∏ –∫–æ–º–º—É–Ω–∞–ª–∫–∞", OperationType.TOPUP,
                "–∂–∏–ª—å–µ", "–¥–æ–º", "–∫–≤–∞—Ä—Ç–∏—Ä–∞", "–∞–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã",
                "–∞—Ä–µ–Ω–¥–∞", "–Ω–∞–µ–º", "—Å—ä–µ–º",
                "–∏–ø–æ—Ç–µ–∫–∞", "–∫—Ä–µ–¥–∏—Ç", "–≤–∑–Ω–æ—Å",
                "–∫–æ–º–º—É–Ω–∞–ª–∫–∞", "–∂–∫—Ö", "–∫–≤–∞—Ä—Ç–ø–ª–∞—Ç–∞",
                "—ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ", "—Å–≤–µ—Ç", "—ç–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è",
                "–≤–æ–¥–∞", "—Ö–æ–ª–æ–¥–Ω–∞—è –≤–æ–¥–∞", "–≥–æ—Ä—è—á–∞—è –≤–æ–¥–∞", "–≤–æ–¥–æ—Å–Ω–∞–±–∂–µ–Ω–∏–µ",
                "–≥–∞–∑", "–æ—Ç–æ–ø–ª–µ–Ω–∏–µ", "—Ç–µ–ø–ª–æ",
                "–∏–Ω—Ç–µ—Ä–Ω–µ—Ç", "wi-fi", "—Ä–æ—Å—Ç–µ–ª–µ–∫–æ–º", "–º—Ç—Å", "–±–∏–ª–∞–π–Ω",
                "—Ç–µ–ª–µ–≤–∏–¥–µ–Ω–∏–µ", "—Ç–≤", "–∫–∞–±–µ–ª—å–Ω–æ–µ",
                "—É–±–æ—Ä–∫–∞", "–∫–ª–∏–Ω–∏–Ω–≥", "–¥–æ–º—Ä–∞–±–æ—Ç–Ω–∏—Ü–∞",
                "—Ä–µ–º–æ–Ω—Ç", "—Å—Ç—Ä–æ–π–∫–∞", "–º–∞—Ç–µ—Ä–∏–∞–ª—ã", "–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã"));

        categories.add(new Category("üëï –û–¥–µ–∂–¥–∞ –∏ –æ–±—É–≤—å", OperationType.TOPUP,
                "–æ–¥–µ–∂–¥–∞", "–≤–µ—â–∏", "–≥–∞—Ä–¥–µ—Ä–æ–±",
                "–æ–±—É–≤—å", "–∫—Ä–æ—Å—Å–æ–≤–∫–∏", "—Ç—É—Ñ–ª–∏", "—Å–∞–ø–æ–≥–∏", "–±–æ—Ç–∏–Ω–∫–∏",
                "–≤–µ—Ä—Ö–Ω—è—è", "–∫—É—Ä—Ç–∫–∞", "–ø–∞–ª—å—Ç–æ", "–ø—É—Ö–æ–≤–∏–∫", "—à—É–±–∞",
                "–Ω–∏–∂–Ω–µ–µ", "–±–µ–ª—å–µ", "—Ç—Ä—É—Å—ã", "–Ω–æ—Å–∫–∏", "–∫–æ–ª–≥–æ—Ç–∫–∏",
                "–∞–∫—Å–µ—Å—Å—É–∞—Ä—ã", "—Å—É–º–∫–∞", "—Ä—é–∫–∑–∞–∫", "–∫–æ—à–µ–ª–µ–∫", "—Ä–µ–º–µ–Ω—å",
                "—É–∫—Ä–∞—à–µ–Ω–∏—è", "–±–∏–∂—É—Ç–µ—Ä–∏—è", "—á–∞—Å—ã", "–∫–æ–ª—å—Ü–æ", "—Ü–µ–ø–æ—á–∫–∞",
                "—à–æ–ø–∏–Ω–≥", "–ø–æ–∫—É–ø–∫–∏", "–º–∞–≥–∞–∑–∏–Ω", "–∞—à–∞–Ω", "–ª–µ–Ω—Ç–∞", "–ø–µ—Ä–µ–∫—Ä–µ—Å—Ç–æ–∫"));

        categories.add(new Category("üè• –ó–¥–æ—Ä–æ–≤—å–µ –∏ –∫—Ä–∞—Å–æ—Ç–∞", OperationType.TOPUP,
                "–∑–¥–æ—Ä–æ–≤—å–µ", "–º–µ–¥–∏—Ü–∏–Ω–∞", "–ª–µ—á–µ–Ω–∏–µ",
                "–∞–ø—Ç–µ–∫–∞", "–ª–µ–∫–∞—Ä—Å—Ç–≤–∞", "—Ç–∞–±–ª–µ—Ç–∫–∏", "–≤–∏—Ç–∞–º–∏–Ω—ã", "–±–∞–¥",
                "–≤—Ä–∞—á", "–¥–æ–∫—Ç–æ—Ä", "—Ç–µ—Ä–∞–ø–µ–≤—Ç", "—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç",
                "—Å—Ç–æ–º–∞—Ç–æ–ª–æ–≥", "–∑—É–±—ã", "–ª–µ—á–µ–Ω–∏–µ –∑—É–±–æ–≤", "—á–∏—Å—Ç–∫–∞",
                "–±–æ–ª—å–Ω–∏—Ü–∞", "–∫–ª–∏–Ω–∏–∫–∞", "–º–µ–¥—Ü–µ–Ω—Ç—Ä",
                "—Å–ø–æ—Ä—Ç", "—Ñ–∏—Ç–Ω–µ—Å", "—Ç—Ä–µ–Ω–∞–∂–µ—Ä–Ω—ã–π", "–∑–∞–ª", "–±–∞—Å—Å–µ–π–Ω",
                "–π–æ–≥–∞", "–ø–∏–ª–∞—Ç–µ—Å", "–∫—Ä–æ—Å—Å—Ñ–∏—Ç",
                "–º–∞—Å—Å–∞–∂", "—Å–ø–∞", "—Å–∞—É–Ω–∞", "–±–∞–Ω—è",
                "–∫–æ—Å–º–µ—Ç–∏–∫–∞", "–ø–∞—Ä—Ñ—é–º", "–¥—É—Ö–∏", "–∫—Ä–µ–º", "—à–∞–º–ø—É–Ω—å",
                "–ø–∞—Ä–∏–∫–º–∞—Ö–µ—Ä", "—Å—Ç—Ä–∏–∂–∫–∞", "–º–∞–Ω–∏–∫—é—Ä", "–ø–µ–¥–∏–∫—é—Ä"));

        categories.add(new Category("üéâ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è –∏ –æ—Ç–¥—ã—Ö", OperationType.TOPUP,
                "—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è", "–æ—Ç–¥—ã—Ö", "–¥–æ—Å—É–≥",
                "–∫–∏–Ω–æ", "—Ñ–∏–ª—å–º", "–∫–∏–Ω–æ—Ç–µ–∞—Ç—Ä", "–ø—Ä–µ–º—å–µ—Ä–∞",
                "–∫–æ–Ω—Ü–µ—Ä—Ç", "—à–æ—É", "–≤—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ", "—Ñ–µ—Å—Ç–∏–≤–∞–ª—å",
                "—Ç–µ–∞—Ç—Ä", "–æ–ø–µ—Ä–∞", "–±–∞–ª–µ—Ç", "—Å–ø–µ–∫—Ç–∞–∫–ª—å",
                "–º—É–∑–µ–π", "–≤—ã—Å—Ç–∞–≤–∫–∞", "–≥–∞–ª–µ—Ä–µ—è",
                "–±–∞—Ä", "–ø–∞–±", "–∫–ª—É–±", "–¥–∏—Å–∫–æ—Ç–µ–∫–∞", "–∫–∞—Ä–∞–æ–∫–µ",
                "–æ—Ç–ø—É—Å–∫", "–ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ", "—Ç—É—Ä", "–æ—Ç–µ–ª—å", "–≥–æ—Å—Ç–∏–Ω–∏—Ü–∞",
                "–±–∏–ª–µ—Ç—ã", "–∞–≤–∏–∞–±–∏–ª–µ—Ç—ã", "–∂–¥ –±–∏–ª–µ—Ç—ã",
                "—Ö–æ–±–±–∏", "–∏–≥—Ä—ã", "–∏–≥—Ä—É—à–∫–∏", "–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä",
                "–∫–Ω–∏–≥–∏", "–∂—É—Ä–Ω–∞–ª—ã", "–∫–æ–º–∏–∫—Å—ã"));

        categories.add(new Category("üéì –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ", OperationType.TOPUP,
                "–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ", "—É—á—ë–±–∞", "–æ–±—É—á–µ–Ω–∏–µ",
                "–∫—É—Ä—Å—ã", "—Ç—Ä–µ–Ω–∏–Ω–≥", "—Å–µ–º–∏–Ω–∞—Ä", "–≤–µ–±–∏–Ω–∞—Ä",
                "–∫–Ω–∏–≥–∏", "—É—á–µ–±–Ω–∏–∫", "–ø–æ—Å–æ–±–∏–µ", "–ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞",
                "—Ä–µ–ø–µ—Ç–∏—Ç–æ—Ä", "–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å", "—É—á–∏—Ç–µ–ª—å",
                "—à–∫–æ–ª–∞", "—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç", "–∏–Ω—Å—Ç–∏—Ç—É—Ç", "–∫–æ–ª–ª–µ–¥–∂",
                "–∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—è", "—Ñ–æ—Ä—É–º", "–º–∏—Ç–∞–ø",
                "—è–∑—ã–∫–∏", "–∞–Ω–≥–ª–∏–π—Å–∫–∏–π", "–∏—Å–ø–∞–Ω—Å–∫–∏–π", "–∫–∏—Ç–∞–π—Å–∫–∏–π",
                "–æ–Ω–ª–∞–π–Ω-–∫—É—Ä—Å", "coursera", "stepik", "udemy"));


        categories.add(new Category("üí∞ –ó–∞—Ä–ø–ª–∞—Ç–∞", OperationType.DEBIT,
                "–∑–∞—Ä–ø–ª–∞—Ç–∞", "–∑–ø", "–æ–∫–ª–∞–¥",
                "–∞–≤–∞–Ω—Å", "—Ä–∞—Å—á–µ—Ç", "–≤—ã–ø–ª–∞—Ç–∞",
                "–ø—Ä–µ–º–∏—è", "–±–æ–Ω—É—Å", "–≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ",
                "–∫–æ–º–ø–µ–Ω—Å–∞—Ü–∏—è", "–æ—Ç–ø—É—Å–∫–Ω—ã–µ", "–±–æ–ª—å–Ω–∏—á–Ω—ã–π"));

        return categories;
    }

}
